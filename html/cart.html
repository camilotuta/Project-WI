<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - Greenhouse Fitness</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .cart-container {
            max-width: 1200px;
            margin: 100px auto 50px;
            padding: 0 2rem;
        }
        
        .cart-header {
            margin-bottom: 2rem;
        }
        
        .cart-header h1 {
            font-size: var(--font-size-3xl);
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }
        
        .cart-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }
        
        .cart-items {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-base);
        }
        
        .cart-item {
            display: grid;
            grid-template-columns: 100px 1fr auto auto auto;
            gap: 1.5rem;
            align-items: center;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .item-image {
            width: 100px;
            height: 100px;
            border-radius: var(--border-radius);
            overflow: hidden;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }
        
        .item-details h3 {
            font-size: var(--font-size-lg);
            margin-bottom: 0.5rem;
            color: var(--gray-900);
        }
        
        .item-details p {
            color: var(--gray-600);
            font-size: var(--font-size-sm);
        }
        
        .item-price {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--gray-100);
            padding: 0.5rem;
            border-radius: var(--border-radius);
        }
        
        .item-quantity button {
            width: 30px;
            height: 30px;
            border: none;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }
        
        .item-quantity button:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .item-quantity span {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }
        
        .item-subtotal {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .item-remove {
            background: none;
            border: none;
            color: var(--error-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: var(--transition-fast);
        }
        
        .item-remove:hover {
            transform: scale(1.2);
        }
        
        .cart-summary {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-base);
            height: fit-content;
            position: sticky;
            top: 100px;
        }
        
        .cart-summary h2 {
            font-size: var(--font-size-2xl);
            margin-bottom: 1.5rem;
            color: var(--gray-900);
        }
        
        .summary-line {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            color: var(--gray-700);
        }
        
        .summary-line.total {
            border-top: 2px solid var(--gray-200);
            margin-top: 1rem;
            padding-top: 1rem;
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .checkout-btn {
            width: 100%;
            margin-top: 1.5rem;
        }
        
        .empty-cart {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .empty-cart-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }
        
        .empty-cart h2 {
            font-size: var(--font-size-2xl);
            color: var(--gray-700);
            margin-bottom: 1rem;
        }
        
        .empty-cart p {
            color: var(--gray-600);
            margin-bottom: 2rem;
        }
        
        @media (max-width: 768px) {
            .cart-content {
                grid-template-columns: 1fr;
            }
            
            .cart-item {
                grid-template-columns: 80px 1fr;
                gap: 1rem;
            }
            
            .item-price,
            .item-quantity,
            .item-subtotal {
                grid-column: 2;
            }
            
            .item-remove {
                grid-column: 2;
                justify-self: end;
            }
        }
    </style>
</head>
<body>
    <!-- Mini Header -->
    <header class="main-header">
        <div class="container header-content">
            <div class="logo">
                <h1><a href="../pages/homepage.html">üåø Greenhouse Fitness</a></h1>
            </div>
            <div class="header-actions">
                <a href="../pages/homepage.html" class="btn btn-outline">‚Üê Seguir Comprando</a>
            </div>
        </div>
    </header>

    <main class="cart-container">
        <div class="cart-header">
            <h1>üõí Mi Carrito</h1>
            <p id="cart-items-count">Cargando...</p>
        </div>
        
        <div id="cart-content">
            <!-- Se llenar√° din√°micamente -->
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script>
        let currentCart = null;
        
        // Verificar autenticaci√≥n al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            const user = API.getUser();
            if (!user) {
                window.location.href = '../html/login.html';
                return;
            }
            
            await loadCart();
        });
        
        // Cargar carrito
        async function loadCart() {
            const user = API.getUser();
            const cartContent = document.getElementById('cart-content');
            const itemsCount = document.getElementById('cart-items-count');
            
            try {
                const response = await API.Carrito.get(user.id_usuario);
                currentCart = response.data;
                
                const { items, totales } = currentCart;
                
                if (!items || items.length === 0) {
                    renderEmptyCart();
                    return;
                }
                
                itemsCount.textContent = `${totales.total_items || 0} ${totales.total_items === 1 ? 'producto' : 'productos'}`;
                
                cartContent.innerHTML = `
                    <div class="cart-content">
                        <div class="cart-items" id="cart-items-list">
                            ${items.map(item => renderCartItem(item)).join('')}
                        </div>
                        
                        <div class="cart-summary">
                            <h2>Resumen del Pedido</h2>
                            
                            <div class="summary-line">
                                <span>Subtotal (${totales.total_productos || 0} items):</span>
                                <span>${API.formatPrice(totales.total || 0)}</span>
                            </div>
                            
                            <div class="summary-line">
                                <span>Env√≠o:</span>
                                <span>${API.formatPrice(15000)}</span>
                            </div>
                            
                            <div class="summary-line">
                                <span>IVA (19%):</span>
                                <span>${API.formatPrice((totales.total || 0) * 0.19)}</span>
                            </div>
                            
                            <div class="summary-line total">
                                <span>Total:</span>
                                <span>${API.formatPrice((totales.total || 0) * 1.19 + 15000)}</span>
                            </div>
                            
                            <button class="btn btn-primary checkout-btn" onclick="checkout()">
                                Proceder al Pago
                            </button>
                            
                            <button class="btn btn-outline checkout-btn" onclick="clearCart()">
                                Vaciar Carrito
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error cargando carrito:', error);
                API.showNotification('Error cargando carrito', 'error');
            }
        }
        
        // Renderizar item del carrito
        function renderCartItem(item) {
            return `
                <div class="cart-item" data-cart-id="${item.id_carrito}">
                    <div class="item-image">üèãÔ∏è</div>
                    
                    <div class="item-details">
                        <h3>${item.nombre}</h3>
                        <p>${item.descripcion || ''}</p>
                        <p style="color: var(--primary-color); font-weight: 600;">
                            ${API.formatPrice(item.precio)} c/u
                        </p>
                    </div>
                    
                    <div class="item-quantity">
                        <button onclick="updateQuantity(${item.id_carrito}, ${item.cantidad - 1})">‚àí</button>
                        <span>${item.cantidad}</span>
                        <button onclick="updateQuantity(${item.id_carrito}, ${item.cantidad + 1})">+</button>
                    </div>
                    
                    <div class="item-subtotal">
                        ${API.formatPrice(item.subtotal)}
                    </div>
                    
                    <button class="item-remove" onclick="removeItem(${item.id_carrito})" title="Eliminar">
                        ‚úï
                    </button>
                </div>
            `;
        }
        
        // Renderizar carrito vac√≠o
        function renderEmptyCart() {
            const cartContent = document.getElementById('cart-content');
            const itemsCount = document.getElementById('cart-items-count');
            
            itemsCount.textContent = '0 productos';
            
            cartContent.innerHTML = `
                <div class="cart-items empty-cart">
                    <div class="empty-cart-icon">üõí</div>
                    <h2>Tu carrito est√° vac√≠o</h2>
                    <p>Agrega productos para comenzar tu compra</p>
                    <a href="../pages/homepage.html" class="btn btn-primary">
                        Ver Productos
                    </a>
                </div>
            `;
        }
        
        // Actualizar cantidad
        async function updateQuantity(id_carrito, nuevaCantidad) {
            if (nuevaCantidad < 1) {
                if (confirm('¬øDeseas eliminar este producto del carrito?')) {
                    await removeItem(id_carrito);
                }
                return;
            }
            
            try {
                await API.Carrito.updateQuantity(id_carrito, nuevaCantidad);
                await loadCart();
                await API.updateCartCount();
            } catch (error) {
                API.showNotification('Error actualizando cantidad', 'error');
            }
        }
        
        // Eliminar item
        async function removeItem(id_carrito) {
            try {
                await API.Carrito.remove(id_carrito);
                API.showNotification('Producto eliminado del carrito', 'success');
                await loadCart();
                await API.updateCartCount();
            } catch (error) {
                API.showNotification('Error eliminando producto', 'error');
            }
        }
        
        // Vaciar carrito
        async function clearCart() {
            if (!confirm('¬øEst√°s seguro de vaciar todo el carrito?')) return;
            
            const user = API.getUser();
            
            try {
                await API.Carrito.clear(user.id_usuario);
                API.showNotification('Carrito vaciado', 'success');
                await loadCart();
                await API.updateCartCount();
            } catch (error) {
                API.showNotification('Error vaciando carrito', 'error');
            }
        }
        
        // Procesar pago
        async function checkout() {
            const user = API.getUser();
            if (!currentCart || !currentCart.items || currentCart.items.length === 0) {
                API.showNotification('El carrito est√° vac√≠o', 'warning');
                return;
            }
            
            const { items, totales } = currentCart;
            
            // Preparar datos del pedido
            const pedido = {
                id_usuario: user.id_usuario,
                subtotal: totales.total,
                impuestos: totales.total * 0.19,
                envio: 15000,
                total: totales.total * 1.19 + 15000,
                metodo_pago: 'tarjeta', // Esto deber√≠a venir de un formulario
                direccion_envio: user.direccion || 'Direcci√≥n no especificada',
                notas: ''
            };
            
            const pedidoItems = items.map(item => ({
                id_producto: item.id_producto,
                cantidad: item.cantidad,
                precio_unitario: item.precio,
                subtotal: item.subtotal
            }));
            
            try {
                API.showNotification('Procesando pedido...', 'info');
                
                const response = await API.Pedidos.create(pedido, pedidoItems);
                
                if (response.success) {
                    API.showNotification('¬°Pedido realizado exitosamente!', 'success');
                    
                    setTimeout(() => {
                        // Redirigir a confirmaci√≥n
                        alert(`Pedido #${response.data.id_pedido} creado exitosamente!\n\nTotal: ${API.formatPrice(pedido.total)}\n\nRecibir√°s un email con los detalles.`);
                        window.location.href = '../pages/homepage.html';
                    }, 2000);
                }
            } catch (error) {
                API.showNotification('Error procesando pedido: ' + error.message, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>