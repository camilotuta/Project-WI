<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Producto - Greenhouse Fitness</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <style>
      .product-detail-container {
        max-width: 1200px;
        margin: 100px auto 50px;
        padding: 0 2rem;
      }

      .product-detail {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
        margin-bottom: 3rem;
      }

      .product-gallery {
        position: sticky;
        top: 100px;
        height: fit-content;
      }

      .main-image {
        width: 100%;
        aspect-ratio: 1;
        background: var(--bg-primary);
        border-radius: var(--border-radius-xl);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8rem;
        margin-bottom: 1rem;
      }

      .product-info h1 {
        font-size: var(--font-size-3xl);
        color: var(--gray-900);
        margin-bottom: 1rem;
      }

      .product-meta {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .rating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .rating .stars {
        font-size: 1.2rem;
      }

      .product-price-box {
        background: var(--bg-primary);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        margin-bottom: 2rem;
      }

      .price-current {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
      }

      .price-original {
        font-size: 1.5rem;
        color: var(--gray-400);
        text-decoration: line-through;
        margin-left: 1rem;
      }

      .discount-badge {
        display: inline-block;
        background: var(--error-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: var(--border-radius);
        font-size: var(--font-size-sm);
        font-weight: 600;
        margin-left: 1rem;
      }

      .stock-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        color: var(--success-color);
        font-weight: 600;
      }

      .quantity-selector {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .quantity-selector label {
        font-weight: 600;
        color: var(--gray-700);
      }

      .quantity-input {
        display: flex;
        align-items: center;
        background: var(--gray-100);
        border-radius: var(--border-radius);
        padding: 0.5rem;
      }

      .quantity-input button {
        width: 40px;
        height: 40px;
        border: none;
        background: white;
        border-radius: var(--border-radius);
        font-size: 1.5rem;
        cursor: pointer;
        transition: var(--transition-fast);
      }

      .quantity-input button:hover {
        background: var(--primary-color);
        color: white;
      }

      .quantity-input input {
        width: 60px;
        text-align: center;
        border: none;
        background: transparent;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .action-buttons .btn {
        flex: 1;
        padding: 1rem;
        font-size: var(--font-size-lg);
      }

      .product-features {
        background: var(--gray-50);
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        margin-bottom: 2rem;
      }

      .product-features ul {
        list-style: none;
      }

      .product-features li {
        padding: 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .product-features li::before {
        content: "‚úì";
        color: var(--success-color);
        font-weight: bold;
        font-size: 1.2rem;
      }

      .tabs {
        margin-top: 3rem;
      }

      .tab-buttons {
        display: flex;
        gap: 1rem;
        border-bottom: 2px solid var(--gray-200);
        margin-bottom: 2rem;
      }

      .tab-btn {
        padding: 1rem 2rem;
        border: none;
        background: none;
        cursor: pointer;
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--gray-600);
        border-bottom: 3px solid transparent;
        transition: var(--transition-fast);
      }

      .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .reviews-list {
        display: grid;
        gap: 1.5rem;
      }

      .review-card {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-base);
      }

      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .review-author {
        font-weight: 600;
        color: var(--gray-900);
      }

      .review-date {
        color: var(--gray-500);
        font-size: var(--font-size-sm);
      }

      .related-products {
        margin-top: 3rem;
      }

      .related-products h2 {
        font-size: var(--font-size-2xl);
        margin-bottom: 2rem;
      }

      @media (max-width: 768px) {
        .product-detail {
          grid-template-columns: 1fr;
        }

        .action-buttons {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- Mini Header -->
    <header class="main-header">
      <div class="container header-content">
        <div class="logo">
          <h1><a href="../pages/homepage.html">üåø Greenhouse Fitness</a></h1>
        </div>
        <div class="header-actions">
          <a href="../pages/homepage.html" class="btn btn-outline">‚Üê Volver</a>
          <button class="cart-btn" onclick="goToCart()">
            üõí Carrito
            <span class="cart-count">0</span>
          </button>
        </div>
      </div>
    </header>

    <main class="product-detail-container">
      <div id="product-detail" class="product-detail">
        <!-- Se llenar√° din√°micamente -->
      </div>

      <div class="tabs">
        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="description">
            Descripci√≥n
          </button>
          <button class="tab-btn" data-tab="reviews">Rese√±as</button>
          <button class="tab-btn" data-tab="info">Informaci√≥n Adicional</button>
        </div>

        <div class="tab-content active" id="description-tab">
          <div id="product-description"></div>
        </div>

        <div class="tab-content" id="reviews-tab">
          <div id="product-reviews"></div>
        </div>

        <div class="tab-content" id="info-tab">
          <div id="product-additional-info"></div>
        </div>
      </div>

      <div class="related-products">
        <h2>Productos Relacionados</h2>
        <div id="related-products" class="products-grid"></div>
      </div>
    </main>

    <script src="../js/api.js"></script>
    <script>
      let currentProduct = null;
      let currentQuantity = 1;

      document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get("id");

        if (!productId) {
          window.location.href = "../pages/homepage.html";
          return;
        }

        await loadProductDetail(productId);
        await loadProductReviews(productId);
        await loadRelatedProducts(productId);
        setupTabs();
        API.updateCartCount();
      });

      async function loadProductDetail(id) {
        try {
          const response = await API.Productos.getById(id);
          currentProduct = response.data;

          const hasDiscount =
            currentProduct.precio_original &&
            currentProduct.precio_original > currentProduct.precio;
          const discount = hasDiscount
            ? Math.round(
                ((currentProduct.precio_original - currentProduct.precio) /
                  currentProduct.precio_original) *
                  100
              )
            : 0;

          document.title = `${currentProduct.nombre} - Greenhouse Fitness`;

          const productDetail = document.getElementById("product-detail");
          productDetail.innerHTML = `
                    <div class="product-gallery">
                        <div class="main-image">
                            ${getCategoryIcon(currentProduct.nombre_categoria)}
                        </div>
                    </div>
                    
                    <div class="product-info">
                        <h1>${currentProduct.nombre}</h1>
                        
                        <div class="product-meta">
                            <div class="rating">
                                <span class="stars">${"‚≠ê".repeat(
                                  Math.round(
                                    parseFloat(
                                      currentProduct.valoracion_promedio
                                    ) || 0
                                  )
                                )}</span>
                                <span>(${
                                  currentProduct.total_valoraciones || 0
                                } rese√±as)</span>
                            </div>
                            <div>
                                <span style="color: var(--gray-600);">Categor√≠a:</span>
                                <strong>${
                                  currentProduct.nombre_categoria
                                }</strong>
                            </div>
                        </div>
                        
                        <div class="product-price-box">
                            <div>
                                <span class="price-current">${API.formatPrice(
                                  currentProduct.precio
                                )}</span>
                                ${
                                  hasDiscount
                                    ? `
                                    <span class="price-original">${API.formatPrice(
                                      currentProduct.precio_original
                                    )}</span>
                                    <span class="discount-badge">-${discount}%</span>
                                `
                                    : ""
                                }
                            </div>
                            <div class="stock-info">
                                ${
                                  currentProduct.stock > 0
                                    ? `‚úì ${currentProduct.stock} disponibles`
                                    : "‚úó Agotado"
                                }
                            </div>
                        </div>
                        
                        <div class="quantity-selector">
                            <label>Cantidad:</label>
                            <div class="quantity-input">
                                <button onclick="changeQuantity(-1)">‚àí</button>
                                <input type="number" id="quantity" value="1" min="1" max="${
                                  currentProduct.stock
                                }" readonly>
                                <button onclick="changeQuantity(1)">+</button>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="addToCartDetail()" 
                                    ${
                                      currentProduct.stock === 0
                                        ? "disabled"
                                        : ""
                                    }>
                                ${
                                  currentProduct.stock === 0
                                    ? "Agotado"
                                    : "Agregar al Carrito"
                                }
                            </button>
                            <button class="btn btn-secondary" onclick="buyNow()" 
                                    ${
                                      currentProduct.stock === 0
                                        ? "disabled"
                                        : ""
                                    }>
                                Comprar Ahora
                            </button>
                        </div>
                        
                        <div class="product-features">
                            <h3 style="margin-bottom: 1rem;">Caracter√≠sticas</h3>
                            <ul>
                                <li>Env√≠o gratis en compras superiores a $100.000</li>
                                <li>Garant√≠a de 30 d√≠as</li>
                                <li>Productos 100% originales</li>
                                <li>Pago seguro</li>
                            </ul>
                        </div>
                    </div>
                `;

          // Llenar descripci√≥n
          document.getElementById("product-description").innerHTML = `
                    <p style="font-size: var(--font-size-lg); line-height: 1.8; color: var(--gray-700);">
                        ${
                          currentProduct.descripcion ||
                          "No hay descripci√≥n disponible."
                        }
                    </p>
                `;

          // Si es un suplemento, cargar info adicional
          if (currentProduct.id_categoria === 4) {
            await loadSupplementInfo(id);
          }
        } catch (error) {
          console.error("Error cargando producto:", error);
          API.showNotification("Producto no encontrado", "error");
          setTimeout(
            () => (window.location.href = "../pages/homepage.html"),
            2000
          );
        }
      }

      async function loadSupplementInfo(id_producto) {
        try {
          const response = await API.Suplementos.getByProductId(id_producto);
          const suplemento = response.data;

          document.getElementById("product-additional-info").innerHTML = `
                    <div style="display: grid; gap: 2rem;">
                        <div>
                            <h3 style="margin-bottom: 1rem;">Tipo</h3>
                            <p>${suplemento.tipo}</p>
                        </div>
                        
                        <div>
                            <h3 style="margin-bottom: 1rem;">Ingredientes</h3>
                            <ul style="list-style: disc; padding-left: 1.5rem;">
                                ${suplemento.ingredientes
                                  .map((ing) => `<li>${ing}</li>`)
                                  .join("")}
                            </ul>
                        </div>
                        
                        <div>
                            <h3 style="margin-bottom: 1rem;">Beneficios</h3>
                            <ul style="list-style: disc; padding-left: 1.5rem;">
                                ${suplemento.beneficios
                                  .map((ben) => `<li>${ben}</li>`)
                                  .join("")}
                            </ul>
                        </div>
                        
                        <div>
                            <h3 style="margin-bottom: 1rem;">Dosis Recomendada</h3>
                            <p>${suplemento.dosis_recomendada}</p>
                        </div>
                        
                        ${
                          suplemento.advertencias
                            ? `
                            <div style="background: #fff3cd; padding: 1rem; border-radius: var(--border-radius);">
                                <h3 style="margin-bottom: 0.5rem; color: var(--warning-color);">‚ö†Ô∏è Advertencias</h3>
                                <p>${suplemento.advertencias}</p>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
        } catch (error) {
          console.error("Error cargando info del suplemento:", error);
        }
      }

      async function loadProductReviews(id) {
        try {
          const response = await API.Valoraciones.getByProduct(id);
          const reviews = response.data;

          const reviewsContainer = document.getElementById("product-reviews");

          if (reviews.length === 0) {
            reviewsContainer.innerHTML =
              "<p>No hay rese√±as a√∫n. ¬°S√© el primero en dejar una!</p>";
            return;
          }

          reviewsContainer.innerHTML = `
                    <div class="reviews-list">
                        ${reviews
                          .map(
                            (review) => `
                            <div class="review-card">
                                <div class="review-header">
                                    <span class="review-author">${
                                      review.nombre_usuario
                                    }</span>
                                    <span class="review-date">${API.formatDate(
                                      review.fecha_valoracion
                                    )}</span>
                                </div>
                                <div class="rating">
                                    <span class="stars">${"‚≠ê".repeat(
                                      review.puntuacion
                                    )}</span>
                                </div>
                                <p style="margin-top: 1rem; line-height: 1.6;">${
                                  review.comentario || "Sin comentario"
                                }</p>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                `;
        } catch (error) {
          console.error("Error cargando rese√±as:", error);
        }
      }

      async function loadRelatedProducts(id) {
        try {
          const response = await API.Productos.getRelated(id, 4);
          const products = response.data;

          const relatedContainer = document.getElementById("related-products");
          relatedContainer.innerHTML = products
            .map((product) => createProductCard(product))
            .map((card) => card.outerHTML)
            .join("");
        } catch (error) {
          console.error("Error cargando productos relacionados:", error);
        }
      }

      function createProductCard(producto) {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
                <div class="product-image">
                    <div class="placeholder-image">${getCategoryIcon(
                      producto.nombre_categoria
                    )}</div>
                </div>
                <div class="product-content">
                    <h3>${producto.nombre}</h3>
                    <div class="product-price">
                        <span class="current-price">${API.formatPrice(
                          producto.precio
                        )}</span>
                    </div>
                    <a href="product-detail.html?id=${
                      producto.id_producto
                    }" class="btn btn-primary">Ver Detalles</a>
                </div>
            `;
        return card;
      }

      function getCategoryIcon(nombre) {
        const icons = {
          Gimnasio: "üèãÔ∏è",
          Pilates: "üßò",
          Cardio: "üèÉ",
          Suplementos: "üíä",
          Accesorios: "üéØ",
        };
        return icons[nombre] || "üì¶";
      }

      function changeQuantity(delta) {
        const input = document.getElementById("quantity");
        const newValue = parseInt(input.value) + delta;
        if (newValue >= 1 && newValue <= currentProduct.stock) {
          input.value = newValue;
          currentQuantity = newValue;
        }
      }

      async function addToCartDetail() {
        const user = API.getUser();
        if (!user) {
          API.showNotification("Debes iniciar sesi√≥n", "warning");
          setTimeout(() => (window.location.href = "../html/login.html"), 1500);
          return;
        }

        const quantity = parseInt(document.getElementById("quantity").value);

        try {
          await API.Carrito.add(
            user.id_usuario,
            currentProduct.id_producto,
            quantity
          );
          API.showNotification(
            `‚úì ${quantity} producto(s) agregado(s) al carrito`,
            "success"
          );
          await API.updateCartCount();
        } catch (error) {
          API.showNotification("Error agregando al carrito", "error");
        }
      }

      async function buyNow() {
        await addToCartDetail();
        setTimeout(() => (window.location.href = "../html/cart.html"), 1000);
      }

      function goToCart() {
        window.location.href = "../html/cart.html";
      }

      function setupTabs() {
        const tabButtons = document.querySelectorAll(".tab-btn");
        const tabContents = document.querySelectorAll(".tab-content");

        tabButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const tabName = btn.dataset.tab;

            tabButtons.forEach((b) => b.classList.remove("active"));
            tabContents.forEach((c) => c.classList.remove("active"));

            btn.classList.add("active");
            document.getElementById(`${tabName}-tab`).classList.add("active");
          });
        });
      }
    </script>
  </body>
</html>
